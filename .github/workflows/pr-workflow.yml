name: CI/CD Test/Validation
on:
  pull_request:
    branches:
      - develop

#concurrency:
#  group: ${{ github.head_ref || github.ref_name }} 
#  cancel-in-progress: true

jobs:
  #check reviewers status
  reviewers:
    runs-on: ubuntu-latest 
    concurrency:
      group: ${{ github.head_ref || github.ref_name }}
      cancel-in-progress: true
    steps:
    #  - name: cancel concurrent jobs
    #    run: echo ${{lastjobid}}
    #  - name: Download Pull Request Artifact
    #    uses: actions/download-artifact@v3
    #    with:
    #      name: ${{ github.head_ref }}
    #      path: WorkflowRunLog.txt
      - name: Download artifact
        id: download-artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}  # Required, if the repo is private a Personal Access Token with `repo` scope is needed
          workflow: pr-workflow.yml #${{ github.event.workflow_run.workflow_id }}
          pr: ${{github.event.pull_request.number}}
          name: ${{ github.head_ref }} # Optional, uploaded artifact name
          path: WorkflowRunLog.txt
          check_artifacts:  true # default false, just try to download artifact from the last workflow
          #skip_unpack: false
          if_no_artifact_found: fail
      #read from file and assign to outputs object
      - name: Read and assign id to be cancelled
        id: output_test
        run: |
          input_file="WorkflowRunLog.txt"
          echo ::set-output name=new_value::$(tail -n 1 input_file)
      # test to see if done correctly - should echo "value"
      - run: echo ${​​{​​​​​​​​​ steps.output_test.outputs.new_value }​​​​​​​​​​​}​​​​​​​​​​​​​​​​​​ #if it works add here the SFDX command to cancel the running job in CI
      - name: Create Workflow Artifact
        run: |
          echo "Writing in workflow log file..."
          echo ${{ github.run_id }} >> WorkflowRunLog.txt
        #env:
        #  lastjobid: ${{ github.run_id }}
      - name: Update Workflow Artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ github.head_ref }} # source branch of the pull request
          path: WorkflowRunLog.txt #need to create a folder to store this >> need to delete this artifact when merging the branch
          retention-days: 7
      - name: Reviews Counter
        uses: jrylan/github-action-reviews-counter@v1.0.0
        with:
          repo-token: '${{ secrets.GITHUB_TOKEN }}'
      - name: Sleep for 30 seconds
        uses: jakejarvis/wait-action@master
        with:
          time: '90s'
      - name: Check review status
        uses: jrylan/github-action-reviews-counter@v1.0.0
        if: 'steps.reviews.outputs.approved < 1 && steps.reviews.outputs.changes_requested != 0'
        with:
          script: |
              core.setFailed('There are no reviews for this request.')
      - name: Check pull request approval status
        uses: actions/github-script@v6
        if: ${{ !contains(('nereagit'), github.actor)}} && github.event.review.state != 'approved'
        with:
          script: |
              core.setFailed('This PR needs to be approved make sure to add the right reviewers!')   
  
 