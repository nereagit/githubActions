name: CI/CD Test/Validation
on:
  pull_request:
    branches:
      - develop

#concurrency:
#  group: ${{ github.head_ref || github.ref_name }} 
#  cancel-in-progress: true

jobs:
  #check reviewers status
  reviewers:
    runs-on: ubuntu-latest 
    concurrency:
      group: ${{ github.head_ref || github.ref_name }}
      cancel-in-progress: true
     
    steps:
     #  - name: cancel concurrent jobs
     #    run: echo ${{lastjobid}}
      - name: Create Workflow Artifact
        run: |
          echo "Writing in workflow log file..."
          echo ${{ github.run_id }} >> WorkflowRunLog.txt
        #env:
        #  lastjobid: ${{ github.run_id }}
      - name: Create Workflow Artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ github.head_ref }} # source branch of the pull request
          path: WorkflowRunLog.txt #need to create a folder to store this >> need to delete this artifact when merging the branch
      - name: Reviews Counter
        uses: jrylan/github-action-reviews-counter@v1.0.0
        with:
          repo-token: '${{ secrets.GITHUB_TOKEN }}'
      - name: Sleep for 30 seconds
        uses: jakejarvis/wait-action@master
        with:
          time: '90s'
      - name: Check review status
        uses: jrylan/github-action-reviews-counter@v1.0.0
        if: 'steps.reviews.outputs.approved < 1 && steps.reviews.outputs.changes_requested != 0'
        with:
          script: |
              core.setFailed('There are no reviews for this request.')
      - name: Check pull request approval status
        uses: actions/github-script@v6
        if: ${{ !contains(('nereagit'), github.actor)}} && github.event.review.state != 'approved'
        with:
          script: |
              core.setFailed('This PR needs to be approved make sure to add the right reviewers!')   
  
 